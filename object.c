#include <stdio.h>
#include <X11/Xlib.h>
#include <X11/Xutil.h>
#include <X11/keysym.h>
#include <stdarg.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "object.h"

int map[720][1280],map2[720][1280],i,j,k,l,dx,dy;
int dist[23][41];
int pre[23][41];
int rmap[23][41];
int order_i[23*41];
int order_j[23*41];
int size=23*41;

typedef struct queue {
    int tail;
    int head;
    int data[23*41][2];
} queue_t;

void init_queue(queue_t *queue){
    queue->head=0;
    queue->tail=-1;
}

void push(queue_t *queue, int i, int j){
    queue->data[(queue->tail+1)%size][0] = i;
    queue->data[(queue->tail+1)%size][1] = j;
    queue->tail=(queue->tail+1)%size;
}

int pop(queue_t *queue){
    int res=0;

    //res/100がi,res%100がj
    res = (queue->data[queue->head][0])*100+queue->data[queue->head][1];

    /* データの先頭を１つ後ろにずらす */
    queue->head=(queue->head+1)%size;

    return res;
}

int is_empty(queue_t *queue) {
    if((queue->tail+1)%size==queue->head){
        return 1;
    }else {
        return 0;
    }
}

//車体
int car[36][53]={
    {0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,1,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,1,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,5,3,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,3,5,0,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,5,5,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,5,5,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,7,5,3,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,3,5,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,8,7,3,0,0,0,0,0,0,0,0,4,5,9,7,7,10,10,10,7,0,0,4,0,0,0,0,0,0,0,3,7,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,8,4,3,0,0,0,0,0,0,0,0,4,5,0,0,0,0,0,0,0,3,0,4,0,0,0,0,0,0,0,3,4,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,7,4,7,0,0,0,0,0,9,9,9,1,5,0,7,7,7,7,7,7,0,5,1,9,9,0,0,0,0,0,7,4,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,7,4,7,0,0,0,0,5,11,7,9,5,5,11,8,7,7,11,8,8,0,5,5,7,11,5,0,0,0,0,7,4,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,7,4,7,0,0,0,5,3,11,0,3,5,3,11,7,11,9,9,7,10,3,5,5,3,11,3,5,0,0,0,7,4,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,7,4,7,0,5,5,3,11,3,9,9,5,3,11,11,9,9,9,9,7,3,5,5,11,0,11,3,3,5,5,7,4,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,8,4,7,9,5,5,3,11,3,5,5,5,7,8,7,7,7,7,7,8,7,5,5,5,3,11,0,3,5,9,7,4,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,7,4,7,0,5,5,3,3,5,5,5,5,7,12,7,7,7,7,7,12,7,5,5,5,5,3,3,3,5,5,7,4,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,7,4,7,0,5,3,3,3,5,5,5,5,8,4,8,8,8,8,8,4,7,5,5,5,5,3,3,3,3,5,7,4,7,0,0,0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,5,5,0,7,4,7,3,3,3,3,5,5,5,5,5,8,4,8,8,8,8,8,4,7,5,5,5,5,5,3,3,3,3,7,4,7,0,5,5,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,5,5,5,0,7,4,7,3,3,3,3,5,5,5,5,5,8,4,8,8,8,8,8,4,7,0,5,5,5,5,3,3,3,3,7,4,7,0,5,5,5,0,0,0,0,0,0},
    {0,0,0,0,0,5,1,5,5,0,7,4,7,9,3,3,3,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,3,3,3,9,7,4,7,3,5,1,1,5,5,0,0,0,0},
    {0,0,0,3,3,1,1,5,5,3,7,4,7,9,3,3,3,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,3,3,3,9,7,4,7,3,3,5,1,1,1,3,0,0,0},
    {0,0,0,5,5,1,1,5,3,3,7,4,7,9,3,3,3,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,3,3,3,9,7,4,7,3,3,1,1,1,1,5,0,0,0},
    {0,0,0,5,5,1,1,5,3,3,7,4,7,9,3,3,5,9,9,13,13,14,14,14,14,14,14,14,14,14,14,14,13,13,9,9,5,5,3,9,7,4,7,3,3,1,1,1,1,5,0,0,0},
    {0,0,3,1,1,1,1,5,3,3,7,4,7,3,3,3,5,9,13,13,13,14,14,14,14,14,14,14,14,14,14,14,13,13,13,9,5,5,3,3,7,4,7,3,3,5,1,1,1,1,3,0,0},
    {0,3,5,1,1,1,1,5,3,3,7,4,7,3,3,3,5,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,5,5,3,3,7,4,7,3,3,5,1,1,1,1,5,3,0},
    {0,3,1,1,1,1,5,3,3,3,9,7,9,3,5,5,1,9,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,9,5,1,5,3,9,7,9,3,3,3,5,1,1,1,5,3,0},
    {0,3,1,1,1,5,3,3,3,3,1,3,5,5,5,1,9,9,8,8,7,11,3,3,7,8,8,8,8,3,3,3,3,8,8,9,9,9,1,5,5,3,3,1,3,3,3,5,5,1,1,3,0},
    {3,1,1,1,1,5,3,5,5,3,3,9,3,3,3,3,9,7,8,11,9,9,9,9,11,7,8,8,11,9,9,9,9,11,7,7,9,9,3,3,3,9,3,3,5,5,3,5,5,1,1,3,0},
    {3,1,1,5,5,3,5,3,5,3,9,9,9,3,9,9,9,7,7,9,9,3,0,9,9,11,7,7,9,3,0,3,3,9,7,7,11,9,9,3,9,9,9,9,3,3,5,3,3,5,1,1,3},
    {3,1,1,3,3,3,1,9,9,9,9,9,3,0,3,3,9,9,9,9,9,0,6,0,9,9,9,9,9,0,6,0,0,9,9,9,9,9,3,0,3,9,9,9,9,9,1,3,3,3,1,1,3},
    {3,1,3,3,3,1,9,9,3,3,9,0,0,6,0,0,0,3,3,0,0,6,4,6,0,3,3,3,0,6,4,6,6,0,3,3,0,0,0,6,0,0,9,9,3,9,9,1,5,3,5,1,3},
    {3,1,3,1,1,9,9,0,3,3,0,6,9,9,9,9,6,0,0,6,6,9,9,9,6,0,0,0,6,9,9,9,9,6,0,0,6,6,9,9,9,6,0,0,3,0,9,9,9,1,3,1,3},
    {3,1,3,1,1,9,0,9,9,9,6,9,9,9,9,9,9,6,6,9,9,9,9,9,9,6,6,6,9,9,9,9,9,9,6,6,9,9,9,9,9,9,0,6,9,9,0,9,9,5,3,1,3},
    {3,1,1,5,9,9,0,9,9,9,6,9,9,9,9,9,9,6,6,9,9,9,9,9,9,6,6,6,9,9,9,9,9,9,6,6,9,9,9,9,9,9,0,6,9,9,0,9,9,5,5,1,3},
    {3,3,1,9,9,9,0,0,3,3,0,0,9,9,9,9,0,0,0,0,0,9,9,9,0,0,0,0,0,9,9,9,9,0,0,0,0,0,9,9,9,0,0,0,3,0,0,3,9,9,5,3,3},
    {3,3,1,9,9,9,9,9,3,3,9,6,0,3,0,0,0,9,9,6,0,0,3,0,6,9,9,9,6,0,3,0,0,0,9,9,6,6,0,3,0,6,9,9,3,9,9,9,9,9,5,3,3},
    {0,3,5,9,9,9,9,9,9,9,9,9,6,6,6,6,9,7,7,11,9,6,6,6,9,7,7,7,9,6,6,6,6,9,7,7,11,9,6,6,6,9,9,9,9,9,9,9,9,9,5,3,0},
    {0,9,9,0,0,0,0,3,3,3,3,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,3,3,3,3,0,0,0,0,9,9,0}
};



void init_object(int width, int height) {  

    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            for(k=0; k<30; k++) {
                for(l=0; l<30; l++) {
                    map[i*30+k][j*30+l]=rmap[i][j];
                }
            }
        }
    }

    for(i=0; i<width; i++) {
        for(j=0; j<height; j++) {
            for(dx=-5; dx<=5; dx++) {
                for(dy=-5; dy<=5; dy++) {
                    if(map[j][i]==1) {
                        if(i+dx>=0 && i+dx<width && j+dy>=0 && j+dy<height && map[j+dy][i+dx]==0) {
                            if((0<=(j+dy)%10 && (j+dy)%10<=4 && 0<=(i+dx)%10 && (i+dx)%10<=4) || (5<=(j+dy)%10 && (j+dy)%10<=9 && 5<=(i+dx)%10 && (i+dx)%10<=9)) {
                                map[j+dy][i+dx]=2;
                            }else {
                                map[j+dy][i+dx]=3;
                            }
                        }
                    }
                }
            }
        }
    }

    for(i=615; i<620; i++) {
        for(j=30; j<60; j++) {
            if((i+j)%2==0) {
                map[i][j]=5;
            }else {
                map[i][j]=4;
            }
        }
    }   

    for(i=60; i<65; i++) {
        for(j=1170; j<1200; j++) {
            if((i+j)%2==0) {
                map[i][j]=5;
            }else {
                map[i][j]=4;
            }
        }
    }
}

void init_rmap() {
    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            rmap[i][j]=0;
        }
    }
}


void dig(int i, int j, int rmap_height, int rmap_width) {
    int up=0,down=0,left=0,right=0;
    while(up==0 || down==0 || left==0 || right==0) {
        int dir=rand()%4;
        if(dir==0) {        //上
            if(i-2>=0 && rmap[i-2][j]==0) {
                rmap[i-1][j]=1;
                rmap[i-2][j]=1;
                dig(i-2,j,rmap_height,rmap_width);
            }
            up=1;
        }else if(dir==1) {  //下
            if(i+2<rmap_height && rmap[i+2][j]==0) {
                rmap[i+1][j]=1;
                rmap[i+2][j]=1;
                dig(i+2,j,rmap_height,rmap_width);
            }
            down=1;
        }else if(dir==2) {  //左
            if(j-2>=0 && rmap[i][j-2]==0) {
                rmap[i][j-1]=1;
                rmap[i][j-2]=1;
                dig(i,j-2,rmap_height,rmap_width);
            }
            left=1;
        }else if(dir==3) {  //右
            if(j+2<rmap_width && rmap[i][j+2]==0) {
                rmap[i][j+1]=1;
                rmap[i][j+2]=1;
                dig(i,j+2,rmap_height,rmap_width);
            }
            right=1;
        }
    }
}

int  bfs(int sx, int sy) {
    int dx[4]={1,0,-1,0};
    int dy[4]={0,1,0,-1};
    int i,j,d;
    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            dist[i][j]=-1;
        }
    }
    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            pre[i][j]=-1;
        }
    }
    queue_t que;
    dist[sx][sy]=0;
    push(&que,sx,sy);
    
    while(is_empty(&que)==0) {
        int front=pop(&que);
        int x=front/100;
        int y=front%100;
        for(d=0; d<4; d++) {
            int nx=x+dx[d];
            int ny=y+dy[d];
        
            if(nx<0 || nx>=23 || ny<0 || ny>=41 || rmap[nx][ny]==0) {
                continue;
            }

            if(dist[nx][ny]!=-1) {
                continue;
            }

            dist[nx][ny]=dist[x][y]+1;
            pre[nx][ny]=x*100+y;
            push(&que,nx,ny);
        }
    }

    for(i=0; i<23*45; i++) {
        order_i[i]=-1;
        order_j[i]=-1;
    }

    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            rmap[i][j]=0;
        }
    }

    rmap[21][39]=2;
    int ni=21,nj=39;
    order_i[dist[ni][nj]]=ni;
    order_j[dist[ni][nj]]=nj;
    while(!(ni==1 && nj==1)) {
        int nn=pre[ni][nj];
        ni=nn/100;
        nj=nn%100;
        rmap[ni][nj]=2;
        order_i[dist[ni][nj]]=ni;
        order_j[dist[ni][nj]]=nj;
    }

    int tmp_rmap[23][41];
    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            tmp_rmap[i][j]=0;
        }
    }
    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            tmp_rmap[i][j]=rmap[22-i][j];
        }
    }

    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            rmap[i][j]=0;
        }
    }

    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            rmap[i][j]=tmp_rmap[i][j];
        }
    }
    
    for(i=0; i<23; i++) {
        for(j=0; j<41; j++) {
            if(rmap[i][j]==2) {
                rmap[i][j]=1;
            }
        }
    }
    
    if(dist[21][39]<300 || dist[21][39]>350 || rmap[20][1]!=1 || rmap[2][39]!=1) {
        return 0;
    }else {
        return dist[21][39];
    }
}